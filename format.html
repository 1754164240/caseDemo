<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>离线开发助手 - XML 树形增强版</title>
    <style>
        :root {
            --bg: #f8f9fa; --panel-bg: #ffffff; --border: #e9ecef;
            --primary: #007bff; --text: #24292e; --key: #6f42c1;
            --tag: #22863a; --attr: #6f42c1; --string: #032f62; 
            --number: #e36209; --guide-line: #e1e4e8;
            --indent-size: 24px;
        }
        body { margin: 0; padding: 20px; font-family: -apple-system, sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box; }
        .toolbar { display: flex; gap: 10px; padding: 10px; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; margin-bottom: 15px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-btn { padding: 6px 15px; border: 1px solid transparent; background: #e9ecef; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }
        button, select, input { padding: 6px 12px; border: 1px solid #ced4da; background: #fff; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .main-content { flex: 1; display: flex; gap: 15px; min-height: 0; }
        .hidden { display: none !important; }
        .pane { flex: 1; display: flex; flex-direction: column; background: var(--panel-bg); border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .pane-header { padding: 8px 12px; background: #f1f3f5; font-size: 12px; font-weight: 600; color: #495057; display: flex; justify-content: space-between; }
        textarea { flex: 1; padding: 15px; border: none; resize: none; font-family: monospace; font-size: 13px; outline: none; background: #fafafa; }
        #outputArea { flex: 1; padding: 15px; overflow: auto; font-family: monospace; font-size: 13px; white-space: pre; }
        
        /* 树形公共样式 */
        .nested-block { padding-left: var(--indent-size); border-left: 1px solid var(--guide-line); margin-left: 5px; }
        details summary { cursor: pointer; list-style: none; position: relative; padding-left: 18px; outline: none; }
        details summary::before { content: '▶'; position: absolute; left: 0; top: 2px; font-size: 10px; color: #999; }
        details[open] > summary::before { transform: rotate(90deg); }
        .key { color: var(--key); } .string { color: var(--string); } .punctuation { color: #444; }
        .xml-tag { color: var(--tag); font-weight: bold; }
        .xml-attr { color: var(--attr); font-style: italic; }
        .xml-val { color: var(--string); }

        /* 身份证生成器样式 */
        .id-gen-container { padding: 30px; display: flex; flex-direction: column; gap: 15px; max-width: 600px; margin: 0 auto; }
        .form-group { display: flex; align-items: center; gap: 10px; }
        .form-group label { width: 70px; font-weight: bold; }
        .id-result-box { margin-top: 15px; padding: 20px; background: #f0f7ff; border: 1px dashed var(--primary); border-radius: 8px; text-align: center; }
        #idResult { font-size: 26px; font-weight: bold; color: var(--primary); letter-spacing: 2px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <div style="display: flex; gap: 5px; margin-right: 15px; border-right: 1px solid #ddd; padding-right: 15px;">
            <button class="tab-btn active" onclick="switchTab('format')">代码格式化</button>
            <button class="tab-btn" onclick="switchTab('idgen')">身份证生成器</button>
        </div>
        <div id="formatTools">
            <select id="mode">
                <option value="json">JSON</option>
                <option value="xml">XML</option>
                <option value="sql">SQL (离线版)</option>
            </select>
            <button class="btn-primary" onclick="handleFormat()">格式化</button>
            <button onclick="copyCurrentText()">复制结果</button>
            <button onclick="toggleAll(true)">全部展开</button>
            <button onclick="toggleAll(false)">全部收起</button>
        </div>
        <div id="idTools" class="hidden">
            <button class="btn-primary" onclick="generateID()">生成号码</button>
            <button onclick="copyCurrentText()">复制号码</button>
        </div>
        <div style="flex: 1"></div>
        <span id="globalMsg" style="color: green; font-size: 12px; opacity: 0; transition: 0.3s;">已完成!</span>
    </div>

    <div id="formatTab" class="main-content">
        <div class="pane"><div class="pane-header">输入 (Raw)</div><textarea id="input" placeholder="请在此粘贴 JSON 或 XML..."></textarea></div>
        <div class="pane"><div class="pane-header">结果 (Formatted)</div><div id="outputArea"></div></div>
    </div>

    <div id="idGenTab" class="main-content hidden">
        <div class="pane">
            <div class="id-gen-container">
                <div class="form-group">
                    <label>地区</label>
                    <select id="p_prov" style="width:150px;"></select>
                    <select id="p_city" style="width:150px;"></select>
                </div>
                <div class="form-group">
                    <label>生日</label>
                    <input type="date" id="birthDate" value="1995-01-01">
                </div>
                <div class="form-group">
                    <label>性别</label>
                    <label style="width:auto;"><input type="radio" name="sex" value="1" checked> 男</label>
                    <label style="width:auto;"><input type="radio" name="sex" value="0"> 女</label>
                </div>
                <div class="id-result-box">
                    <div id="idResult">等待生成...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawFormattedText = "";

        // --- 离线版内置省市数据 ---
        const localAreaData = { "110100": "北京市", "310100": "上海市", "440100": "广州市", "440300": "深圳市", "510100": "成都市", "610100": "西安市", "330100": "杭州市", "320100": "南京市", "420100": "武汉市" };

        function initIdGen() {
            const pSel = document.getElementById('p_prov');
            if(pSel.options.length > 0) return;
            for(let code in localAreaData) pSel.add(new Option(localAreaData[code], code));
            const cSel = document.getElementById('p_city');
            pSel.onchange = () => { cSel.innerHTML = ""; cSel.add(new Option(localAreaData[pSel.value], pSel.value)); };
            pSel.onchange();
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.main-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('formatTools').classList.add('hidden');
            document.getElementById('idTools').classList.add('hidden');
            if(tab === 'format') {
                document.getElementById('formatTab').classList.remove('hidden');
                document.getElementById('formatTools').classList.remove('hidden');
                document.querySelector('[onclick="switchTab(\'format\')"]').classList.add('active');
            } else {
                document.getElementById('idGenTab').classList.remove('hidden');
                document.getElementById('idTools').classList.remove('hidden');
                document.querySelector('[onclick="switchTab(\'idgen\')"]').classList.add('active');
                initIdGen();
            }
        }

        // --- 核心：XML 树形解析器 ---
        function buildXmlTree(node) {
            // 文本节点处理
            if (node.nodeType === 3) {
                const text = node.nodeValue.trim();
                if (!text) return null;
                const span = document.createElement('span');
                span.className = 'xml-val';
                span.textContent = text;
                return span;
            }

            // 元素节点处理
            const hasChildren = node.children.length > 0;
            const hasText = node.childNodes.length === 1 && node.childNodes[0].nodeType === 3;
            
            const container = document.createElement('div');
            
            // 构建属性字符串
            let attrHtml = "";
            for (let attr of node.attributes) {
                attrHtml += ` <span class="xml-attr">${attr.name}</span><span class="punctuation">="</span><span class="xml-val">${attr.value}</span><span class="punctuation">"</span>`;
            }

            if (!hasChildren && hasText) {
                // 单行显示：<tag>value</tag>
                container.style.paddingLeft = '20px';
                container.innerHTML = `<span class="punctuation">&lt;</span><span class="xml-tag">${node.nodeName}</span>${attrHtml}<span class="punctuation">&gt;</span><span class="xml-val">${node.textContent}</span><span class="punctuation">&lt;/</span><span class="xml-tag">${node.nodeName}</span><span class="punctuation">&gt;</span>`;
            } else if (!hasChildren) {
                // 自闭合：<tag />
                container.style.paddingLeft = '20px';
                container.innerHTML = `<span class="punctuation">&lt;</span><span class="xml-tag">${node.nodeName}</span>${attrHtml} <span class="punctuation">/&gt;</span>`;
            } else {
                // 嵌套折叠结构
                const det = document.createElement('details');
                det.open = true;
                const sum = document.createElement('summary');
                sum.innerHTML = `<span class="punctuation">&lt;</span><span class="xml-tag">${node.nodeName}</span>${attrHtml}<span class="punctuation">&gt;</span>`;
                det.appendChild(sum);

                const inner = document.createElement('div');
                inner.className = 'nested-block';
                for (let child of node.childNodes) {
                    const childRes = buildXmlTree(child);
                    if (childRes) inner.appendChild(childRes);
                }
                det.appendChild(inner);

                const foot = document.createElement('div');
                foot.style.paddingLeft = '20px';
                foot.innerHTML = `<span class="punctuation">&lt;/</span><span class="xml-tag">${node.nodeName}</span><span class="punctuation">&gt;</span>`;
                det.appendChild(foot);
                container.appendChild(det);
            }
            return container;
        }

        // --- 简单离线美化函数 ---
        function simpleSqlFormat(sql) { return sql.replace(/\s+/g, ' ').replace(/\s?(SELECT|FROM|WHERE|AND|OR|GROUP BY|ORDER BY|INSERT|UPDATE|DELETE|SET|VALUES|LIMIT)\s/gi, '\n$1 ').trim(); }
        
        function formatXmlRaw(xml) {
            let formatted = '', indent = '';
            xml.split(/>\s*</).forEach(node => {
                if (node.match(/^\/\w/)) indent = indent.substring(4);
                formatted += indent + '<' + node + '>\r\n';
                if (node.match(/^<?\w[^>]*[^\/]$/)) indent += '    ';
            });
            return formatted.substring(1, formatted.length - 3);
        }

        function handleFormat() {
            const input = document.getElementById('input').value.trim();
            const mode = document.getElementById('mode').value;
            const output = document.getElementById('outputArea');
            output.innerHTML = '';
            if (!input) return;

            try {
                if (mode === 'json') {
                    const obj = JSON.parse(input);
                    rawFormattedText = JSON.stringify(obj, null, 4);
                    output.appendChild(buildJsonTree(obj, null, true));
                } else if (mode === 'xml') {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(input, "text/xml");
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) throw new Error("XML 格式非法");
                    rawFormattedText = formatXmlRaw(input); 
                    output.appendChild(buildXmlTree(xmlDoc.documentElement));
                } else if (mode === 'sql') {
                    rawFormattedText = simpleSqlFormat(input);
                    output.innerText = rawFormattedText;
                }
            } catch (e) { output.innerText = "解析错误: " + e.message; }
        }

        function buildJsonTree(data, key, isLast) {
            const container = document.createElement('div');
            if (typeof data !== 'object' || data === null) {
                container.style.paddingLeft = '20px';
                container.innerHTML = (key ? `<span class="key">"${key}"</span>: ` : "") + `<span class="string">${JSON.stringify(data)}</span>${isLast ? '' : ','}`;
                return container;
            }
            const isArray = Array.isArray(data);
            const det = document.createElement('details'); det.open = true;
            const sum = document.createElement('summary');
            sum.innerHTML = (key ? `<span class="key">"${key}"</span>: ` : "") + (isArray ? '[' : '{');
            det.appendChild(sum);
            const inner = document.createElement('div'); inner.className = 'nested-block';
            const keys = Object.keys(data);
            keys.forEach((k, i) => inner.appendChild(buildJsonTree(data[k], isArray?null:k, i===keys.length-1)));
            det.appendChild(inner);
            const foot = document.createElement('div'); foot.style.paddingLeft = '20px';
            foot.innerHTML = (isArray ? ']' : '}') + (isLast ? '' : ',');
            det.appendChild(foot);
            return det;
        }

        function toggleAll(open) { document.querySelectorAll('details').forEach(d => d.open = open); }

        function copyCurrentText() {
            const textToCopy = rawFormattedText || document.getElementById('idResult').innerText;
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy; document.body.appendChild(textArea);
            textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea);
            const m = document.getElementById('globalMsg'); m.style.opacity = 1;
            setTimeout(() => m.style.opacity = 0, 2000);
        }

        function generateID() {
            const areaCode = document.getElementById('p_city').value;
            const dateStr = document.getElementById('birthDate').value.replace(/-/g, '');
            const sex = document.querySelector('input[name="sex"]:checked').value;
            let seq = Math.floor(Math.random() * 99).toString().padStart(2, '0');
            const lastSeq = sex == '1' ? [1,3,5,7,9][Math.floor(Math.random()*5)] : [0,2,4,6,8][Math.floor(Math.random()*5)];
            const base = areaCode + dateStr + seq + lastSeq;
            const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
            const codes = ['1', '0', 'X', '9', '8', '7', '6', '5', '4', '3', '2'];
            let sum = 0;
            for(let i=0; i<17; i++) sum += parseInt(base[i]) * weights[i];
            document.getElementById('idResult').innerText = base + codes[sum % 11];
        }
    </script>
</body>
</html>