# 多模型配置功能测试指南

## 测试前准备

### 1. 确保数据库服务运行
确保 PostgreSQL 数据库服务正在运行。

### 2. 运行数据库迁移
```bash
# Windows
bat\create-model-configs-table.bat

# 或手动运行
cd backend
python create_model_configs_table.py
```

预期结果:
- ✅ 创建 model_configs 表成功
- ✅ 迁移现有配置为默认模型(如果存在)
- ✅ 显示当前配置列表

### 3. 启动后端服务
```bash
cd backend
python main.py
```

### 4. 启动前端服务
```bash
cd frontend
npm run dev
```

## 测试用例

### 测试 1: 访问模型配置页面

**步骤:**
1. 使用超级管理员账号登录系统
2. 在左侧菜单中点击"系统管理"
3. 点击"模型配置"标签页

**预期结果:**
- ✅ 左侧菜单显示"系统管理"选项
- ✅ 系统管理页面显示"模型配置"标签页
- ✅ 成功进入模型配置管理页面
- ✅ 页面显示配置列表表格
- ✅ 如果已有配置,显示现有配置(包括迁移的默认配置)

### 测试 2: 查看现有配置

**步骤:**
1. 在模型配置列表中查看现有配置

**预期结果:**
- ✅ 显示配置的所有信息:
  - 默认标识(金色星标)
  - 配置名称和显示名称
  - 模型信息(模型名称、提供商标签)
  - API Base URL
  - 脱敏的 API Key
  - 参数(温度、Max Tokens)
  - 状态(启用/禁用)
  - 操作按钮(编辑、删除)
- ✅ API Key 正确脱敏(显示前4位和后4位,中间用*代替)
- ✅ 默认配置显示金色星标

### 测试 3: 添加新模型配置

**步骤:**
1. 点击右上角"添加模型配置"按钮
2. 填写表单:
   - 配置名称: `test-model`
   - 显示名称: `测试模型`
   - 描述: `用于测试的模型配置`
   - API Key: `sk-test-key-1234567890abcdef`
   - API Base URL: `https://api.test.com/v1`
   - 模型名称: `test-model-v1`
   - 提供商: 选择 `custom`
   - 温度参数: `0.8`
   - 最大 Token 数: `2000`
   - 模型类型: `chat`
   - 启用: 勾选
3. 点击"确定"

**预期结果:**
- ✅ 表单验证通过
- ✅ 显示"创建成功"提示
- ✅ 模态框关闭
- ✅ 列表刷新,显示新添加的配置
- ✅ 新配置的 API Key 正确脱敏
- ✅ 如果是第一个配置,自动设为默认

### 测试 4: 编辑模型配置

**步骤:**
1. 在列表中找到刚添加的配置
2. 点击"编辑"按钮
3. 修改信息:
   - 显示名称改为: `测试模型(已修改)`
   - 温度参数改为: `0.9`
4. 点击"确定"

**预期结果:**
- ✅ 编辑表单正确回显所有字段
- ✅ API Key 字段显示完整的 Key(不脱敏)
- ✅ 配置名称字段禁用(不可修改)
- ✅ 显示"更新成功"提示
- ✅ 列表刷新,显示更新后的信息

### 测试 5: 设置默认模型

**步骤:**
1. 确保列表中至少有2个配置
2. 找到一个非默认的配置
3. 点击该配置的灰色星标图标

**预期结果:**
- ✅ 显示"默认模型已更新"提示
- ✅ 该配置的星标变为金色
- ✅ 原默认配置的星标变为灰色
- ✅ 列表重新排序,默认配置排在最前面

### 测试 6: 尝试删除默认模型

**步骤:**
1. 找到默认模型配置(金色星标)
2. 点击"删除"按钮

**预期结果:**
- ✅ 删除按钮显示为禁用状态
- ✅ 鼠标悬停显示提示"不能删除默认模型配置"
- ✅ 无法触发删除操作

### 测试 7: 删除非默认模型

**步骤:**
1. 找到一个非默认的配置
2. 点击"删除"按钮
3. 在确认对话框中点击"确定"

**预期结果:**
- ✅ 显示删除确认对话框
- ✅ 显示"删除成功"提示
- ✅ 列表刷新,该配置已被移除

### 测试 8: 表单验证

**步骤:**
1. 点击"添加模型配置"
2. 尝试提交空表单
3. 尝试输入无效的配置名称(如包含空格或特殊字符)

**预期结果:**
- ✅ 必填字段显示错误提示
- ✅ 配置名称格式验证生效
- ✅ 无法提交无效表单

### 测试 9: API Key 脱敏

**步骤:**
1. 在列表中查看 API Key 列
2. 编辑一个配置查看 API Key 字段

**预期结果:**
- ✅ 列表中 API Key 正确脱敏:
  - 长度 > 8: 显示前4位 + * + 后4位
  - 长度 ≤ 8: 显示原值
- ✅ 编辑表单中显示完整 API Key
- ✅ 使用密码输入框(可切换显示/隐藏)

### 测试 10: 权限控制

**步骤:**
1. 使用普通用户账号登录
2. 尝试访问系统管理页面

**预期结果:**
- ✅ 左侧菜单不显示"系统管理"选项
- ✅ 直接访问 `/settings` 路径返回 403 错误或重定向

### 测试 11: AI Service 使用默认模型

**步骤:**
1. 设置一个模型为默认
2. 上传需求文档
3. 生成测试点

**预期结果:**
- ✅ AI Service 自动使用默认模型配置
- ✅ 测试点生成成功
- ✅ 后端日志显示使用的模型信息

### 测试 12: 配置列表过滤

**步骤:**
1. 创建一个配置并设为禁用状态
2. 刷新页面查看列表

**预期结果:**
- ✅ 默认显示所有配置(包括禁用的)
- ✅ 禁用的配置显示"禁用"标签
- ✅ 启用的配置显示"启用"标签

## 边界测试

### 测试 13: 重复配置名称

**步骤:**
1. 尝试创建与现有配置同名的配置

**预期结果:**
- ✅ 显示错误提示"模型配置名称已存在"
- ✅ 无法创建

### 测试 14: 禁用默认模型

**步骤:**
1. 编辑默认模型配置
2. 尝试取消"启用"开关
3. 保存

**预期结果:**
- ✅ 可以保存
- ✅ 但该配置仍然是默认模型
- ⚠️ 注意: 应该阻止禁用默认模型,这是一个需要改进的点

### 测试 15: 设置禁用的配置为默认

**步骤:**
1. 创建一个配置并设为禁用
2. 尝试点击星标设为默认

**预期结果:**
- ✅ 显示错误提示"不能将未启用的模型设为默认"
- ✅ 操作失败

### 测试 16: 长文本处理

**步骤:**
1. 创建配置时输入很长的描述文本
2. 输入很长的 API Base URL

**预期结果:**
- ✅ 文本正确保存
- ✅ 列表中长文本正确显示(可能需要截断或换行)

## 性能测试

### 测试 17: 大量配置

**步骤:**
1. 创建 20+ 个模型配置
2. 查看列表加载速度
3. 切换默认模型

**预期结果:**
- ✅ 列表加载流畅
- ✅ 分页功能正常
- ✅ 切换默认模型响应快速

## 集成测试

### 测试 18: 端到端流程

**步骤:**
1. 添加新的 OpenAI 模型配置
2. 设为默认模型
3. 上传需求文档
4. 生成测试点
5. 生成测试用例
6. 切换到另一个模型配置
7. 再次生成测试点

**预期结果:**
- ✅ 整个流程顺畅
- ✅ 不同模型配置生成的结果可能不同
- ✅ 无错误发生

## 测试报告模板

```
测试日期: YYYY-MM-DD
测试人员: [姓名]
测试环境: 
  - 操作系统: Windows/Linux/Mac
  - 浏览器: Chrome/Firefox/Safari
  - 数据库: PostgreSQL [版本]

测试结果:
  - 通过: [数量]
  - 失败: [数量]
  - 跳过: [数量]

失败用例:
  1. [测试用例编号] - [失败原因]
  2. ...

问题和建议:
  1. ...
  2. ...
```

## 已知问题

1. 可以禁用默认模型配置(应该阻止)
2. 删除配置时没有检查是否正在被使用
3. 没有配置使用历史记录

## 改进建议

1. 添加配置测试功能(测试 API 连接)
2. 添加配置克隆功能
3. 添加配置导入/导出功能
4. 添加配置使用统计
5. 支持配置分组或标签

