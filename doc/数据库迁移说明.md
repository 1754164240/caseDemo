# 数据库迁移说明

## 添加测试点和测试用例编号字段

### 迁移内容

本次迁移为 `test_points` 和 `test_cases` 表添加了 `code` 字段，用于存储编号。

- **测试点编号格式**: `TP-001`, `TP-002`, `TP-003` ...
- **测试用例编号格式**: `TP-001-1`, `TP-001-2`, `TP-002-1` ...

### 执行迁移

#### 方法 1: 使用 Python 脚本（推荐）

```bash
cd backend
python -m scripts.run_migration
```

这个脚本会自动执行 `migrations/001_add_code_fields.sql` 文件中的所有 SQL 语句。

#### 方法 2: 使用 psql 命令行

```bash
cd backend
psql -U postgres -d test_case_db -f migrations/001_add_code_fields.sql
```

#### 方法 3: 手动执行 SQL

如果需要手动执行，可以使用以下 SQL（或直接使用 `migrations/001_add_code_fields.sql` 文件）：

```sql
-- 1. 添加 code 字段到 test_points 表
ALTER TABLE test_points ADD COLUMN code VARCHAR(20);

-- 2. 添加 code 字段到 test_cases 表
ALTER TABLE test_cases ADD COLUMN code VARCHAR(30);

-- 3. 为现有测试点生成编号
DO $$
DECLARE
    tp_record RECORD;
    counter INTEGER := 1;
BEGIN
    FOR tp_record IN 
        SELECT id FROM test_points ORDER BY id
    LOOP
        UPDATE test_points 
        SET code = 'TP-' || LPAD(counter::TEXT, 3, '0')
        WHERE id = tp_record.id;
        counter := counter + 1;
    END LOOP;
END $$;

-- 4. 为现有测试用例生成编号
DO $$
DECLARE
    tc_record RECORD;
    tp_code VARCHAR(20);
    tp_counter INTEGER;
BEGIN
    FOR tc_record IN 
        SELECT tc.id, tp.code as test_point_code
        FROM test_cases tc
        JOIN test_points tp ON tc.test_point_id = tp.id
        ORDER BY tc.test_point_id, tc.id
    LOOP
        -- 获取该测试点下已有的测试用例数量
        SELECT COUNT(*) + 1 INTO tp_counter
        FROM test_cases
        WHERE test_point_id = (
            SELECT test_point_id FROM test_cases WHERE id = tc_record.id
        )
        AND id < tc_record.id;
        
        -- 更新编号
        UPDATE test_cases
        SET code = tc_record.test_point_code || '-' || tp_counter
        WHERE id = tc_record.id;
    END LOOP;
END $$;

-- 5. 创建唯一索引
CREATE UNIQUE INDEX ix_test_points_code ON test_points(code);
CREATE UNIQUE INDEX ix_test_cases_code ON test_cases(code);

-- 6. 设置字段为非空
ALTER TABLE test_points ALTER COLUMN code SET NOT NULL;
ALTER TABLE test_cases ALTER COLUMN code SET NOT NULL;
```

### 回滚迁移

如果需要回滚：

```sql
-- 删除索引
DROP INDEX IF EXISTS ix_test_cases_code;
DROP INDEX IF EXISTS ix_test_points_code;

-- 删除字段
ALTER TABLE test_cases DROP COLUMN IF EXISTS code;
ALTER TABLE test_points DROP COLUMN IF EXISTS code;
```

### 验证迁移

执行以下 SQL 验证迁移是否成功：

```sql
-- 查看测试点编号
SELECT id, code, title FROM test_points ORDER BY code LIMIT 10;

-- 查看测试用例编号
SELECT id, code, title FROM test_cases ORDER BY code LIMIT 10;

-- 检查是否有重复编号
SELECT code, COUNT(*) FROM test_points GROUP BY code HAVING COUNT(*) > 1;
SELECT code, COUNT(*) FROM test_cases GROUP BY code HAVING COUNT(*) > 1;
```

### 注意事项

1. **备份数据库**: 执行迁移前请先备份数据库
2. **停止服务**: 执行迁移时建议停止后端服务
3. **检查编号**: 迁移后检查编号是否正确生成
4. **更新 .env**: 确保 `.env` 文件中使用 `MILVUS_URI` 而不是 `MILVUS_HOST` 和 `MILVUS_PORT`

### 相关文件

- `backend/app/models/test_point.py` - 测试点模型
- `backend/app/models/test_case.py` - 测试用例模型
- `backend/app/schemas/test_point.py` - 测试点 Schema
- `backend/app/schemas/test_case.py` - 测试用例 Schema
- `backend/app/api/v1/endpoints/test_points.py` - 测试点 API
- `backend/app/api/v1/endpoints/test_cases.py` - 测试用例 API
- `backend/alembic/versions/add_code_to_test_point_and_test_case.py` - 迁移脚本
