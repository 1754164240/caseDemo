# 审批功能说明

## 功能概述

为测试点和测试用例添加了完整的审批流程，支持审批通过、审批拒绝和重置审批状态。

---

## 审批状态

系统支持三种审批状态：

| 状态 | 值 | 说明 | 图标 | 颜色 |
|------|------|------|------|------|
| 待审批 | `pending` | 新创建或重置后的默认状态 | 🔄 | 灰色 |
| 已通过 | `approved` | 审批通过 | ✅ | 绿色 |
| 已拒绝 | `rejected` | 审批拒绝 | ❌ | 红色 |

---

## 数据库设计

### 新增字段

为 `test_points` 和 `test_cases` 表添加了以下字段：

```sql
-- 审批状态 (pending/approved/rejected)
approval_status VARCHAR(20) DEFAULT 'pending'

-- 审批人 ID (外键关联 users 表)
approved_by INTEGER REFERENCES users(id)

-- 审批时间
approved_at TIMESTAMP WITH TIME ZONE

-- 审批意见
approval_comment TEXT
```

### 索引优化

为提高查询性能，创建了以下索引：

```sql
CREATE INDEX idx_test_points_approval_status ON test_points(approval_status);
CREATE INDEX idx_test_cases_approval_status ON test_cases(approval_status);
```

### 数据迁移

迁移脚本会自动：
1. 添加新字段
2. 根据旧的 `is_approved` 字段设置初始审批状态
3. 创建性能优化索引

---

## API 接口

### 测试点审批

#### 1. 审批测试点

**接口**: `POST /api/v1/test-points/{test_point_id}/approve`

**请求体**:
```json
{
  "approval_status": "approved",  // 或 "rejected"
  "approval_comment": "审批意见（可选）"
}
```

**响应**: 返回更新后的测试点对象

#### 2. 重置测试点审批状态

**接口**: `POST /api/v1/test-points/{test_point_id}/reset-approval`

**响应**: 返回重置后的测试点对象（状态为 pending）

### 测试用例审批

#### 1. 审批测试用例

**接口**: `POST /api/v1/test-cases/{test_case_id}/approve`

**请求体**:
```json
{
  "approval_status": "approved",  // 或 "rejected"
  "approval_comment": "审批意见（可选）"
}
```

**响应**: 返回更新后的测试用例对象

#### 2. 重置测试用例审批状态

**接口**: `POST /api/v1/test-cases/{test_case_id}/reset-approval`

**响应**: 返回重置后的测试用例对象（状态为 pending）

---

## 前端界面

### 1. 表格列表

#### 审批状态列

在测试点和测试用例列表中新增"审批状态"列，显示：
- 🔄 待审批（灰色标签）
- ✅ 已通过（绿色标签）
- ❌ 已拒绝（红色标签）

#### 操作按钮

**待审批状态**:
- 显示"审批"按钮，点击打开审批模态框

**已通过/已拒绝状态**:
- 显示"重置"按钮，点击重置审批状态为待审批

### 2. 审批模态框

点击"审批"按钮后弹出模态框，包含：

1. **审批对象**: 显示测试点/测试用例的标题或编号
2. **审批结果**: 下拉选择
   - ✅ 通过
   - ❌ 拒绝
3. **审批意见**: 多行文本输入框（可选）

### 3. 详情抽屉

在测试点和测试用例详情抽屉中显示审批信息：

- **审批状态**: 显示当前审批状态标签
- **审批时间**: 显示审批操作的时间（如果已审批）
- **审批意见**: 显示审批人填写的意见（如果有）

---

## 使用流程

### 审批流程

```
创建测试点/用例
    ↓
待审批 (pending)
    ↓
审批人操作
    ├─→ 通过 (approved) ─→ 可重置
    └─→ 拒绝 (rejected) ─→ 可重置
                ↓
            重置审批
                ↓
            待审批 (pending)
```

### 操作步骤

#### 审批通过

1. 在列表中找到待审批的测试点/用例
2. 点击"审批"按钮
3. 选择"通过"
4. 填写审批意见（可选）
5. 点击"提交"

#### 审批拒绝

1. 在列表中找到待审批的测试点/用例
2. 点击"审批"按钮
3. 选择"拒绝"
4. 填写拒绝原因（建议填写）
5. 点击"提交"

#### 重置审批

1. 在列表中找到已审批的测试点/用例
2. 点击"重置"按钮
3. 确认操作
4. 审批状态重置为"待审批"

---

## 权限控制

- 只有资源所有者可以审批自己的测试点和测试用例
- 审批操作会记录审批人 ID 和审批时间
- 审批意见会永久保存，即使重置审批状态

---

## 技术实现

### 后端

**文件修改**:
- `backend/app/models/test_point.py` - 添加审批字段
- `backend/app/models/test_case.py` - 添加审批字段
- `backend/app/schemas/test_point.py` - 添加审批请求模型
- `backend/app/schemas/test_case.py` - 添加审批请求模型
- `backend/app/api/v1/endpoints/test_points.py` - 添加审批接口
- `backend/app/api/v1/endpoints/test_cases.py` - 添加审批接口

**新增文件**:
- `backend/migrations/002_add_approval_fields.sql` - 数据库迁移脚本
- `backend/run_approval_migration.py` - 迁移执行脚本
- `backend/test_approval.py` - 审批功能测试脚本

### 前端

**文件修改**:
- `frontend/src/services/api.ts` - 添加审批 API 方法
- `frontend/src/pages/TestCases.tsx` - 添加审批 UI 和交互

**新增功能**:
- 审批状态渲染函数
- 审批模态框
- 审批操作按钮
- 详情抽屉中的审批信息显示

---

## 测试验证

运行测试脚本验证功能：

```bash
cd backend
.venv\Scripts\python.exe test_approval.py
```

测试内容：
- ✅ 测试点审批通过
- ✅ 测试点审批拒绝
- ✅ 测试点审批重置
- ✅ 测试用例审批通过
- ✅ 测试用例审批拒绝
- ✅ 测试用例审批重置

---

## 注意事项

1. **向后兼容**: 保留了原有的 `is_approved` 字段，确保旧代码兼容
2. **审批记录**: 审批时间和意见会永久保存，即使重置审批状态
3. **权限验证**: 所有审批操作都需要用户认证，且只能审批自己的资源
4. **状态验证**: 审批接口会验证 `approval_status` 必须是 `approved` 或 `rejected`

---

## 未来扩展

可以考虑的功能扩展：

1. **审批历史**: 记录所有审批操作的历史记录
2. **多级审批**: 支持多人审批流程
3. **审批通知**: 审批状态变更时发送通知
4. **批量审批**: 支持批量审批多个测试点/用例
5. **审批统计**: 在仪表板显示审批统计数据
6. **审批权限**: 区分审批人和创建人的权限

---

## 相关文档

- [数据库迁移脚本](../backend/migrations/002_add_approval_fields.sql)
- [测试脚本](../backend/test_approval.py)
- [API 文档](http://localhost:8000/docs) - 启动后端后访问

---

**创建时间**: 2025-11-07  
**版本**: 1.0.0

