# 系统架构文档

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
│                    (http://localhost:5173)                   │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP/WebSocket
                         │
┌────────────────────────▼────────────────────────────────────┐
│                      前端层 (React)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  登录页  │  │  首页    │  │ 需求管理 │  │ 用例管理 │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │           Zustand (状态管理)                          │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │      API Service / WebSocket Service                 │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ REST API / WebSocket
                         │
┌────────────────────────▼────────────────────────────────────┐
│                   后端层 (FastAPI)                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                  API Router                           │  │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐        │  │
│  │  │  认证  │ │  需求  │ │ 测试点 │ │ 用例   │        │  │
│  │  └────────┘ └────────┘ └────────┘ └────────┘        │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                 业务服务层                            │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐     │  │
│  │  │ AI Service │  │  Document  │  │  WebSocket │     │  │
│  │  │ (LangGraph)│  │   Parser   │  │   Manager  │     │  │
│  │  └────────────┘  └────────────┘  └────────────┘     │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              数据访问层 (SQLAlchemy)                  │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ PostgreSQL  │  │   Milvus    │  │  OpenAI API │
│  (数据库)   │  │  (向量库)   │  │   (LLM)     │
└─────────────┘  └─────────────┘  └─────────────┘
```

## 技术栈详解

### 前端技术栈

```
React 18.2
├── TypeScript 5.2          # 类型安全
├── Vite 5.0               # 构建工具
├── React Router 6.21      # 路由管理
├── Ant Design 5.12        # UI 组件库
├── Zustand 4.4            # 状态管理
├── Axios 1.6              # HTTP 客户端
└── Day.js 1.11            # 日期处理
```

### 后端技术栈

```
FastAPI 0.109
├── Uvicorn 0.27           # ASGI 服务器
├── SQLAlchemy 2.0         # ORM
├── Pydantic 2.5           # 数据验证
├── LangChain 1.0.2        # LLM 框架
├── LangGraph 1.0.2        # AI 工作流
├── OpenAI 1.x             # OpenAI API 客户端
├── PyMilvus 2.3           # 向量数据库客户端
├── Python-DOCX 1.1        # DOCX 解析
├── PyPDF2 3.0             # PDF 解析
├── OpenPyXL 3.1           # Excel 解析
└── Python-Jose 3.3        # JWT 认证
```

### 数据库

```
PostgreSQL 15
├── 用户表 (users)
├── 需求表 (requirements)
├── 测试点表 (test_points)
└── 测试用例表 (test_cases)

Milvus 2.3
└── 文档向量集合 (test_cases)
```

## 数据模型

### ER 图

```
┌─────────────┐
│    User     │
│─────────────│
│ id          │◄────┐
│ username    │     │
│ email       │     │
│ password    │     │
└─────────────┘     │
                    │ 1:N
                    │
┌─────────────┐     │
│ Requirement │     │
│─────────────│     │
│ id          │     │
│ title       │     │
│ file_path   │     │
│ status      │     │
│ user_id     │─────┘
└─────────────┘
      │
      │ 1:N
      │
      ▼
┌─────────────┐
│ Test Point  │
│─────────────│
│ id          │
│ title       │
│ description │
│ category    │
│ priority    │
│ requirement_id│
└─────────────┘
      │
      │ 1:N
      │
      ▼
┌─────────────┐
│ Test Case   │
│─────────────│
│ id          │
│ title       │
│ description │
│ test_steps  │
│ expected    │
│ test_point_id│
└─────────────┘
```

## AI 工作流

### LangGraph 工作流图

```
┌─────────────┐
│   开始      │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│  解析需求文档        │
│  (Document Parser)  │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  分析需求内容        │
│  (LangChain + LLM)  │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  提取测试点          │
│  (AI Analysis)      │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  保存到数据库        │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  用户审核/反馈       │
└──────┬──────────────┘
       │
       ├─────► 有反馈 ──┐
       │                │
       │                ▼
       │         ┌─────────────┐
       │         │  重新生成   │
       │         └──────┬──────┘
       │                │
       │◄───────────────┘
       │
       ▼
┌─────────────────────┐
│  生成测试用例        │
│  (LangChain + LLM)  │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│  保存测试用例        │
└──────┬──────────────┘
       │
       ▼
┌─────────────┐
│   结束      │
└─────────────┘
```

## API 架构

### RESTful API 设计

```
/api/v1
├── /auth
│   ├── POST /register      # 用户注册
│   └── POST /login         # 用户登录
├── /users
│   ├── GET  /me            # 获取当前用户
│   ├── PUT  /me            # 更新当前用户
│   └── GET  /              # 获取用户列表
├── /requirements
│   ├── GET    /            # 获取需求列表
│   ├── POST   /            # 创建需求
│   ├── GET    /{id}        # 获取需求详情
│   ├── PUT    /{id}        # 更新需求
│   └── DELETE /{id}        # 删除需求
├── /test-points
│   ├── GET    /            # 获取测试点列表
│   ├── POST   /            # 创建测试点
│   ├── GET    /{id}        # 获取测试点详情
│   ├── PUT    /{id}        # 更新测试点
│   ├── POST   /{id}/feedback # 提交反馈
│   └── DELETE /{id}        # 删除测试点
├── /test-cases
│   ├── GET    /            # 获取测试用例列表
│   ├── POST   /            # 创建测试用例
│   ├── POST   /generate/{test_point_id} # 生成测试用例
│   ├── GET    /{id}        # 获取测试用例详情
│   ├── PUT    /{id}        # 更新测试用例
│   └── DELETE /{id}        # 删除测试用例
├── /dashboard
│   └── GET /stats          # 获取统计数据
└── /ws
    └── /notifications      # WebSocket 连接
```

## 安全架构

### 认证流程

```
┌─────────┐                ┌─────────┐
│  客户端  │                │  服务器  │
└────┬────┘                └────┬────┘
     │                          │
     │  POST /auth/login        │
     │  (username, password)    │
     ├─────────────────────────►│
     │                          │
     │                          │ 验证用户名密码
     │                          │
     │      JWT Token           │
     │◄─────────────────────────┤
     │                          │
     │  保存 Token 到本地       │
     │                          │
     │  GET /api/xxx            │
     │  Header: Bearer Token    │
     ├─────────────────────────►│
     │                          │
     │                          │ 验证 Token
     │                          │
     │      响应数据            │
     │◄─────────────────────────┤
     │                          │
```

### 权限控制

- **公开接口**: 注册、登录
- **认证接口**: 需要 JWT Token
- **授权接口**: 需要特定权限（如管理员）

## WebSocket 架构

### 连接管理

```
┌─────────────────────────────────────┐
│      WebSocket Manager              │
├─────────────────────────────────────┤
│  active_connections: Dict           │
│    user_id -> Set[WebSocket]        │
├─────────────────────────────────────┤
│  + connect(ws, user_id)             │
│  + disconnect(ws, user_id)          │
│  + send_personal_message(msg, uid)  │
│  + broadcast(msg)                   │
│  + notify_test_point_generated()    │
│  + notify_test_case_generated()     │
└─────────────────────────────────────┘
```

### 消息格式

```json
{
  "type": "test_points_generated",
  "requirement_id": 123,
  "count": 5,
  "message": "测试点生成完成，共 5 个"
}
```

## 部署架构

### 开发环境

```
┌──────────────────────────────────────┐
│         开发机器                      │
│  ┌────────────┐  ┌────────────┐     │
│  │   前端     │  │   后端     │     │
│  │ :5173      │  │ :8000      │     │
│  └────────────┘  └────────────┘     │
│                                      │
│  ┌────────────────────────────────┐ │
│  │      Docker Compose            │ │
│  │  ┌──────────┐  ┌──────────┐   │ │
│  │  │PostgreSQL│  │  Milvus  │   │ │
│  │  │  :5432   │  │  :19530  │   │ │
│  │  └──────────┘  └──────────┘   │ │
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

### 生产环境（建议）

```
┌─────────────────────────────────────────┐
│              负载均衡器                  │
│            (Nginx/HAProxy)              │
└────────────┬────────────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
    ▼                 ▼
┌─────────┐      ┌─────────┐
│ 前端服务 │      │ 后端服务 │
│ (Nginx) │      │(Gunicorn)│
└─────────┘      └────┬─────┘
                      │
         ┌────────────┼────────────┐
         │            │            │
         ▼            ▼            ▼
    ┌────────┐  ┌────────┐  ┌────────┐
    │  PG    │  │ Milvus │  │ Redis  │
    │ Master │  │Cluster │  │ Cache  │
    └────────┘  └────────┘  └────────┘
         │
         ▼
    ┌────────┐
    │  PG    │
    │ Slave  │
    └────────┘
```

## 性能优化

### 后端优化
- 异步处理（async/await）
- 数据库连接池
- 查询优化和索引
- Redis 缓存
- 响应压缩

### 前端优化
- 代码分割（Code Splitting）
- 懒加载（Lazy Loading）
- 虚拟滚动（Virtual Scrolling）
- 图片优化
- CDN 加速

### 数据库优化
- 索引优化
- 查询优化
- 分页加载
- 读写分离

## 监控和日志

### 建议的监控方案
- **应用监控**: Sentry
- **性能监控**: New Relic / DataDog
- **日志收集**: ELK Stack
- **指标监控**: Prometheus + Grafana

### 日志级别
- ERROR: 错误信息
- WARNING: 警告信息
- INFO: 一般信息
- DEBUG: 调试信息

## 总结

本系统采用前后端分离架构，使用现代化的技术栈，具有良好的可扩展性和可维护性。通过 LangGraph 和 LangChain 集成 AI 能力，实现智能化的测试用例生成。

