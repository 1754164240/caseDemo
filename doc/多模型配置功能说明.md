# 多模型配置功能说明

## 功能概述

系统现在支持配置和管理多个 AI 模型,可以灵活切换不同的模型配置,满足不同场景的需求。

## 主要特性

### 1. 多模型管理
- ✅ 支持添加多个模型配置
- ✅ 每个配置包含独立的 API Key、API Base URL 和模型名称
- ✅ 支持配置温度参数、最大 Token 数等高级选项
- ✅ 支持标记提供商(OpenAI、ModelScope、Azure 等)

### 2. 默认模型设置
- ✅ 可以设置一个模型为默认模型
- ✅ 系统自动使用默认模型进行 AI 调用
- ✅ 一键切换默认模型

### 3. 配置管理
- ✅ 创建、编辑、删除模型配置
- ✅ 启用/禁用模型配置
- ✅ API Key 自动脱敏显示
- ✅ 配置列表展示所有模型信息

### 4. 安全性
- ✅ 只有超级管理员可以管理模型配置
- ✅ API Key 在列表中自动脱敏
- ✅ 编辑时显示完整 API Key
- ✅ 不能删除默认模型配置

## 数据库结构

### model_configs 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| name | VARCHAR(100) | 配置名称(唯一标识) |
| display_name | VARCHAR(200) | 显示名称 |
| description | TEXT | 配置描述 |
| api_key | TEXT | API Key |
| api_base | VARCHAR(500) | API Base URL |
| model_name | VARCHAR(200) | 模型名称 |
| temperature | VARCHAR(10) | 温度参数(默认 0.7) |
| max_tokens | INTEGER | 最大 token 数 |
| provider | VARCHAR(50) | 提供商 |
| model_type | VARCHAR(50) | 模型类型(chat/completion) |
| is_active | BOOLEAN | 是否启用 |
| is_default | BOOLEAN | 是否为默认模型 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

## 使用指南

### 1. 数据库迁移

首先需要创建 `model_configs` 表并迁移现有配置:

**Windows:**
```bash
bat\create-model-configs-table.bat
```

**手动运行:**
```bash
cd backend
python -m scripts.create_model_configs_table
```

迁移脚本会:
1. 创建 `model_configs` 表
2. 从 `system_configs` 表读取现有的模型配置
3. 将现有配置迁移为默认模型配置

### 2. 访问模型配置页面

1. 使用超级管理员账号登录系统
2. 点击左侧菜单的 **"系统管理"**
3. 点击 **"模型配置"** 标签页
4. 进入模型配置管理页面

### 3. 添加新模型配置

1. 点击右上角 **"添加模型配置"** 按钮
2. 填写配置信息:
   - **配置名称**: 唯一标识,只能包含字母、数字、下划线和连字符(如: `openai-gpt4`)
   - **显示名称**: 用户友好的名称(如: `OpenAI GPT-4`)
   - **描述**: 可选的配置描述
   - **API Key**: 模型的 API 密钥
   - **API Base URL**: API 基础地址
   - **模型名称**: 具体的模型名称(如: `gpt-4`)
   - **提供商**: 选择提供商(OpenAI/ModelScope/Azure/自定义)
   - **温度参数**: 控制输出随机性(默认 0.7)
   - **最大 Token 数**: 可选,限制输出长度
   - **模型类型**: Chat 或 Completion
   - **启用**: 是否启用该配置
3. 点击 **"确定"** 保存

### 4. 编辑模型配置

1. 在配置列表中找到要编辑的配置
2. 点击 **"编辑"** 按钮
3. 修改配置信息
4. 点击 **"确定"** 保存

**注意**: 配置名称(name)创建后不可修改

### 5. 设置默认模型

1. 在配置列表中找到要设为默认的配置
2. 点击该配置行的 **星标图标** ⭐
3. 系统会自动将该配置设为默认,并取消其他配置的默认状态

**默认模型标识**:
- ⭐ 金色星标: 当前默认模型
- ☆ 灰色星标: 非默认模型(点击可设为默认)

### 6. 删除模型配置

1. 在配置列表中找到要删除的配置
2. 点击 **"删除"** 按钮
3. 确认删除

**限制**: 不能删除默认模型配置,需要先设置其他模型为默认

### 7. 启用/禁用配置

编辑配置时,可以切换 **"启用"** 开关来启用或禁用配置。

**注意**: 禁用的配置不能设为默认模型

## 配置示例

### OpenAI GPT-4

```
配置名称: openai-gpt4
显示名称: OpenAI GPT-4
API Key: sk-proj-xxxxxxxxxxxxx
API Base URL: https://api.openai.com/v1
模型名称: gpt-4
提供商: openai
温度参数: 0.7
```

### ModelScope DeepSeek

```
配置名称: modelscope-deepseek
显示名称: ModelScope DeepSeek V3.1
API Key: ms-xxxxxxxxxxxxx
API Base URL: https://api-inference.modelscope.cn/v1
模型名称: deepseek-ai/DeepSeek-V3.1
提供商: modelscope
温度参数: 0.7
```

### Azure OpenAI

```
配置名称: azure-gpt4
显示名称: Azure GPT-4
API Key: your-azure-api-key
API Base URL: https://your-resource.openai.azure.com/
模型名称: gpt-4
提供商: azure
温度参数: 0.7
```

## API 接口

### 获取所有模型配置
```
GET /api/v1/model-configs/
Query Parameters:
  - include_inactive: boolean (是否包含未启用的配置)
```

### 获取单个模型配置
```
GET /api/v1/model-configs/{config_id}
```

### 获取默认模型配置
```
GET /api/v1/model-configs/default/current
```

### 创建模型配置
```
POST /api/v1/model-configs/
Body: ModelConfigCreate
```

### 更新模型配置
```
PUT /api/v1/model-configs/{config_id}
Body: ModelConfigUpdate
```

### 删除模型配置
```
DELETE /api/v1/model-configs/{config_id}
```

### 设置默认模型
```
POST /api/v1/model-configs/set-default
Body: { "model_id": number }
```

## 技术实现

### 后端

1. **数据模型**: `backend/app/models/model_config.py`
   - ModelConfig 模型定义

2. **Schema**: `backend/app/schemas/model_config.py`
   - ModelConfigCreate: 创建配置
   - ModelConfigUpdate: 更新配置
   - ModelConfigResponse: 响应格式
   - SetDefaultModelRequest: 设置默认模型请求

3. **API 路由**: `backend/app/api/v1/endpoints/model_config.py`
   - 完整的 CRUD 操作
   - 默认模型管理

4. **AI Service**: `backend/app/services/ai_service.py`
   - 支持动态选择模型配置
   - 自动使用默认模型
   - 回退到环境变量配置

### 前端

1. **页面组件**: `frontend/src/pages/ModelConfigs.tsx`
   - 模型配置列表
   - 添加/编辑模型配置表单
   - 默认模型切换
   - 删除确认

2. **API 服务**: `frontend/src/services/api.ts`
   - modelConfigAPI: 所有模型配置相关的 API 调用

3. **路由**: `frontend/src/App.tsx`
   - `/model-configs`: 模型配置管理页面(仅管理员)

4. **导航**: `frontend/src/components/Layout.tsx`
   - 添加"模型配置"菜单项

## 注意事项

1. **权限控制**: 只有超级管理员可以访问模型配置管理功能

2. **默认模型**: 系统始终需要一个默认模型,不能删除默认模型配置

3. **配置名称**: 配置名称创建后不可修改,请谨慎命名

4. **API Key 安全**: 
   - 列表中自动脱敏显示
   - 编辑时显示完整 Key
   - 存储在数据库中加密保护

5. **兼容性**: 
   - 如果数据库中没有模型配置,系统会回退到环境变量配置
   - 保持向后兼容

6. **重启**: 某些配置更改可能需要重启后端服务才能完全生效

## 常见问题

### Q: 如何迁移现有配置?
A: 运行 `bat\create-model-configs-table.bat` 脚本,会自动迁移现有配置为默认模型。

### Q: 可以同时使用多个模型吗?
A: 当前版本系统使用默认模型进行 AI 调用。未来版本可能支持在不同场景使用不同模型。

### Q: 删除配置后能恢复吗?
A: 删除操作不可逆,请谨慎操作。建议先禁用配置而不是删除。

### Q: 如何测试新添加的模型配置?
A: 将新配置设为默认模型,然后在系统中生成测试点或测试用例,观察是否正常工作。

### Q: 配置更新后需要重启吗?
A: 模型配置更新后会立即生效,但建议重启后端服务以确保所有组件使用新配置。

## 未来规划

- [ ] 支持在生成测试点/用例时选择特定模型
- [ ] 模型配置的导入/导出功能
- [ ] 模型使用统计和监控
- [ ] 模型性能对比分析
- [ ] 支持更多模型提供商的预设配置

