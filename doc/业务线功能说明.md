# 业务线功能说明

## 功能概述

系统现在支持根据业务线(契约、保全、理赔)生成不同的测试用例。AI 会自动识别测试点所属的业务线,并使用对应的 Prompt 模板生成更专业的测试用例。

## 业务线分类

### 1. 契约业务线 (contract)
- **业务特点**: 投保流程、保单生成、保费计算
- **测试重点**: 保险条款、责任范围、除外责任、核保规则、风险评估

### 2. 保全业务线 (preservation)
- **业务特点**: 保单变更、批改、续保流程
- **测试重点**: 保单信息修改、受益人变更、保额调整、保全规则、生效时间

### 3. 理赔业务线 (claim)
- **业务特点**: 理赔申请、审核、支付流程
- **测试重点**: 理赔条件、责任认定、赔付金额计算、理赔时效、反欺诈检查

## 实现细节

### 数据库变更

在 `test_points` 表中添加了 `business_line` 字段:

```sql
ALTER TABLE test_points ADD COLUMN business_line VARCHAR(50);
```

字段值:
- `contract`: 契约业务线
- `preservation`: 保全业务线
- `claim`: 理赔业务线

### AI 识别业务线

在生成测试点时,AI 会根据需求文档内容自动判断测试点属于哪个业务线,并在返回的 JSON 中包含 `business_line` 字段。

### 测试用例生成

生成测试用例时,系统会根据测试点的 `business_line` 字段选择对应的 Prompt:

- **契约业务线**: 使用 `CONTRACT_TEST_CASE_PROMPT`
- **保全业务线**: 使用 `PRESERVATION_TEST_CASE_PROMPT`
- **理赔业务线**: 使用 `CLAIM_TEST_CASE_PROMPT`
- **未识别**: 使用默认的 `TEST_CASE_PROMPT`

## 系统配置

在系统配置页面的 "Prompt 配置" 中,现在包含以下配置项:

1. **测试点生成 Prompt** (`TEST_POINT_PROMPT`)
   - 用于从需求文档中提取测试点
   - 包含业务线识别逻辑

2. **默认测试用例 Prompt** (`TEST_CASE_PROMPT`)
   - 用于生成通用测试用例

3. **契约业务线测试用例 Prompt** (`CONTRACT_TEST_CASE_PROMPT`)
   - 专门用于契约业务的测试用例生成
   - 关注投保、核保、保单生成等流程

4. **保全业务线测试用例 Prompt** (`PRESERVATION_TEST_CASE_PROMPT`)
   - 专门用于保全业务的测试用例生成
   - 关注保单变更、批改、续保等流程

5. **理赔业务线测试用例 Prompt** (`CLAIM_TEST_CASE_PROMPT`)
   - 专门用于理赔业务的测试用例生成
   - 关注理赔申请、审核、支付等流程

## 使用流程

### 1. 上传需求文档
用户上传需求文档后,系统会自动:
- 解析文档内容
- 使用 AI 提取测试点
- **自动识别每个测试点的业务线**
- 保存测试点及其业务线信息

### 2. 生成测试用例
当用户为测试点生成测试用例时,系统会:
- 读取测试点的 `business_line` 字段
- 根据业务线选择对应的 Prompt 配置
- 使用专业的业务线 Prompt 生成测试用例

### 3. 自定义 Prompt
管理员可以在系统配置页面自定义各业务线的 Prompt:
- 访问 "系统配置" -> "Prompt 配置"
- 编辑对应业务线的 Prompt 模板
- 保存后立即生效

## 数据库迁移

### 使用 Alembic 迁移

```bash
cd backend
alembic upgrade head
```

### 使用 SQL 脚本迁移

```bash
cd backend
psql -U postgres -d test_case_db -f migrations/003_add_business_line.sql
```

### 手动执行 SQL

```sql
ALTER TABLE test_points ADD COLUMN IF NOT EXISTS business_line VARCHAR(50);
```

## 代码变更

### 1. 模型变更
- `backend/app/models/test_point.py`: 添加 `business_line` 字段

### 2. Schema 变更
- `backend/app/schemas/test_point.py`: 添加 `business_line` 字段
- `backend/app/schemas/system_config.py`: 添加三套业务线 Prompt 配置

### 3. AI 服务变更
- `backend/app/services/ai_service.py`:
  - `extract_test_points`: 识别业务线
  - `generate_test_cases`: 根据业务线选择 Prompt

### 4. API 端点变更
- `backend/app/api/v1/endpoints/test_points.py`: 保存业务线信息
- `backend/app/api/v1/endpoints/requirements.py`: 保存业务线信息
- `backend/app/api/v1/endpoints/system_config.py`: 添加业务线 Prompt 配置管理

## 注意事项

1. **向后兼容**: 现有测试点的 `business_line` 字段为空,不影响现有功能
2. **默认行为**: 如果 AI 未识别出业务线,将使用默认 Prompt 生成测试用例
3. **配置优先级**: 数据库中的 Prompt 配置优先于代码中的默认值
4. **重启服务**: 修改 Prompt 配置后无需重启服务,立即生效

## 示例

### 测试点 JSON 示例

```json
{
  "title": "投保人信息验证",
  "description": "验证投保人基本信息的完整性和准确性",
  "category": "功能",
  "priority": "high",
  "business_line": "contract"
}
```

### 测试用例生成日志

```
[INFO] 使用契约业务线 Prompt 生成测试用例
[INFO] 成功生成 3 个测试用例
```

## 未来扩展

可以根据需要添加更多业务线:
1. 在数据库中添加新的业务线值
2. 在系统配置中添加对应的 Prompt 配置
3. 在 AI 服务中添加对应的 Prompt 选择逻辑

