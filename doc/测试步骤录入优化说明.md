# 测试步骤录入优化说明

## 概述

将测试用例编辑界面中的测试步骤录入方式从简单的文本框改为结构化的表单，更符合数据格式要求，提升用户体验。

---

## 改进前后对比

### 改进前

**录入方式**: 单个 TextArea 文本框

```
测试步骤：
┌─────────────────────────────────────────┐
│ 打开登录页面 - 预期: 页面正常显示        │
│ 输入用户名和密码                         │
│ 点击登录按钮 - 预期: 登录成功            │
│                                          │
└─────────────────────────────────────────┘
```

**问题**:
- ❌ 格式不直观，需要记住特定格式
- ❌ 容易输入错误（如忘记 " - 预期: " 分隔符）
- ❌ 不符合数据结构（需要额外解析）
- ❌ 编辑时容易出现格式混乱

### 改进后

**录入方式**: 结构化的卡片列表

```
测试步骤：

┌─ 步骤 1 ──────────────────────────── [×] ─┐
│ 操作步骤：                                 │
│ ┌───────────────────────────────────────┐ │
│ │ 打开登录页面                           │ │
│ └───────────────────────────────────────┘ │
│ 预期结果：                                 │
│ ┌───────────────────────────────────────┐ │
│ │ 页面正常显示                           │ │
│ └───────────────────────────────────────┘ │
└───────────────────────────────────────────┘

┌─ 步骤 2 ──────────────────────────── [×] ─┐
│ 操作步骤：                                 │
│ ┌───────────────────────────────────────┐ │
│ │ 输入用户名和密码                       │ │
│ └───────────────────────────────────────┘ │
│ 预期结果：                                 │
│ ┌───────────────────────────────────────┐ │
│ │                                        │ │
│ └───────────────────────────────────────┘ │
└───────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│         [+] 添加测试步骤                 │
└─────────────────────────────────────────┘
```

**优势**:
- ✅ 结构清晰，字段分离
- ✅ 符合数据格式（直接对应 action 和 expected 字段）
- ✅ 易于添加、删除、编辑步骤
- ✅ 自动编号，无需手动输入序号
- ✅ 预期结果可选，更灵活

---

## 技术实现

### 1. 前端组件

使用 Ant Design 的 `Form.List` 组件实现动态表单列表：

```typescript
<Form.Item label="测试步骤">
  <Form.List name="test_steps">
    {(fields, { add, remove }) => (
      <>
        {fields.map(({ key, name, ...restField }, index) => (
          <Card
            key={key}
            size="small"
            title={`步骤 ${index + 1}`}
            extra={
              fields.length > 1 ? (
                <MinusCircleOutlined
                  onClick={() => remove(name)}
                  style={{ color: '#ff4d4f' }}
                />
              ) : null
            }
            style={{ marginBottom: 16 }}
          >
            <Form.Item
              {...restField}
              name={[name, 'action']}
              label="操作步骤"
              rules={[{ required: true, message: '请输入操作步骤' }]}
            >
              <Input.TextArea
                rows={2}
                placeholder="请输入具体的操作步骤"
              />
            </Form.Item>
            <Form.Item
              {...restField}
              name={[name, 'expected']}
              label="预期结果"
            >
              <Input.TextArea
                rows={2}
                placeholder="请输入该步骤的预期结果（可选）"
              />
            </Form.Item>
          </Card>
        ))}
        <Form.Item>
          <Button
            type="dashed"
            onClick={() => add()}
            block
            icon={<PlusOutlined />}
          >
            添加测试步骤
          </Button>
        </Form.Item>
      </>
    )}
  </Form.List>
</Form.Item>
```

### 2. 数据处理

#### 编辑时（后端 → 前端）

```typescript
const handleEditTestCase = (record: any) => {
  let testStepsValue = record.test_steps
  if (Array.isArray(testStepsValue)) {
    // 清理数据，去掉可能存在的序号和重复的预期标记
    testStepsValue = testStepsValue.map((item: any) => {
      if (typeof item === 'object' && item !== null) {
        let action = item.action || ''
        let expected = item.expected || ''
        
        // 去掉 action 中可能已经存在的序号
        action = action.replace(/^\d+\.\s*/, '')
        // 去掉 action 中可能已经存在的预期部分
        action = action.replace(/\s*-\s*预期:.*$/, '')
        action = action.trim()
        
        return {
          action: action,
          expected: expected
        }
      }
      return item
    })
  } else {
    // 如果没有测试步骤，初始化一个空步骤
    testStepsValue = [{ action: '', expected: '' }]
  }
  
  editTestCaseForm.setFieldsValue({
    ...
    test_steps: testStepsValue,
    ...
  })
}
```

#### 保存时（前端 → 后端）

```typescript
const handleUpdateTestCase = async () => {
  const values = await editTestCaseForm.validateFields()
  
  // 处理 test_steps：添加 step 序号
  const processedValues = { ...values }
  if (values.test_steps && Array.isArray(values.test_steps)) {
    processedValues.test_steps = values.test_steps.map((item: any, index: number) => ({
      step: index + 1,
      action: item.action || '',
      expected: item.expected || ''
    }))
  }
  
  await testCasesAPI.update(editingTestCase.id, processedValues)
}
```

### 3. 数据格式

**前端表单数据**:
```json
{
  "test_steps": [
    {
      "action": "打开登录页面",
      "expected": "页面正常显示"
    },
    {
      "action": "输入用户名和密码",
      "expected": ""
    }
  ]
}
```

**发送到后端的数据**:
```json
{
  "test_steps": [
    {
      "step": 1,
      "action": "打开登录页面",
      "expected": "页面正常显示"
    },
    {
      "step": 2,
      "action": "输入用户名和密码",
      "expected": ""
    }
  ]
}
```

---

## 用户操作指南

### 添加测试步骤

1. 点击 **"添加测试步骤"** 按钮
2. 在 **"操作步骤"** 文本框中输入具体操作
3. 在 **"预期结果"** 文本框中输入预期结果（可选）
4. 重复以上步骤添加更多测试步骤

### 删除测试步骤

- 点击步骤卡片右上角的 **[×]** 图标
- 注意：至少保留一个测试步骤（最后一个步骤无法删除）

### 编辑测试步骤

- 直接在对应的文本框中修改内容
- 步骤序号会自动更新

### 调整步骤顺序

- 目前暂不支持拖拽排序
- 可以通过删除和重新添加来调整顺序

---

## 界面优化

### 模态框调整

- **宽度**: 从 800px 增加到 900px，提供更多空间
- **高度**: 添加滚动支持，最大高度为 `calc(100vh - 200px)`
- **位置**: 距离顶部 20px，避免遮挡

```typescript
<Modal
  width={900}
  style={{ top: 20 }}
  bodyStyle={{ maxHeight: 'calc(100vh - 200px)', overflowY: 'auto' }}
>
```

### 卡片样式

- **大小**: `size="small"` 紧凑布局
- **标题**: 显示步骤序号（自动编号）
- **间距**: 每个卡片之间 16px 间距
- **删除按钮**: 红色图标，位于卡片右上角

---

## 相关文件

### 前端
- `frontend/src/pages/TestCases.tsx` - 测试用例管理页面

### 后端
- `backend/app/api/v1/endpoints/test_cases.py` - 测试用例 API
- `backend/app/schemas/test_case.py` - 测试用例数据模型

### 测试脚本
- `backend/test_edit_with_new_format.py` - 测试新格式的脚本
- `backend/clean_all_test_cases.py` - 清理旧数据的脚本

---

## 注意事项

1. **数据兼容性**: 新格式完全兼容旧数据，编辑时会自动清理旧格式的序号和预期标记

2. **必填字段**: 操作步骤为必填，预期结果为可选

3. **自动编号**: 步骤序号由系统自动生成，无需手动输入

4. **数据清理**: 已有数据中的重复序号和预期标记已通过脚本清理

5. **向后兼容**: 后端 API 保持不变，只是前端录入方式改进

---

## 未来改进方向

1. **拖拽排序**: 支持通过拖拽调整步骤顺序
2. **批量导入**: 支持从 Excel 或文本批量导入测试步骤
3. **模板功能**: 保存常用的测试步骤模板
4. **步骤复制**: 支持复制已有步骤
5. **富文本编辑**: 支持在步骤中添加图片、链接等

---

## 总结

通过将测试步骤录入方式从简单文本框改为结构化表单，实现了：

✅ **更直观的录入体验** - 字段分离，结构清晰  
✅ **更准确的数据格式** - 直接对应后端数据结构  
✅ **更灵活的编辑方式** - 支持添加、删除、修改  
✅ **更好的数据质量** - 避免格式错误和数据混乱  
✅ **更专业的界面** - 符合现代 Web 应用标准  

这一改进大大提升了测试用例管理的效率和准确性！🎉

