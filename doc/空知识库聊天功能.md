# 空知识库聊天功能

## ✅ 功能已实现!

### 功能描述
即使知识库为空(没有上传任何文档),用户也可以直接与 LLM 进行对话,获得基于通用知识的回答。

### 工作原理

#### 之前的行为
```
用户提问 → 检索知识库 → 没有文档 → 返回固定消息:
"抱歉，我在知识库中没有找到与您问题相关的信息。请尝试换一种方式提问，或者上传相关文档到知识库。"
```

#### 现在的行为
```
用户提问 → 检索知识库 → 没有文档 → 直接调用 LLM 对话 → 返回智能回答
```

### 实现细节

#### 修改文件: `backend/app/services/rag_service.py`

**1. 流式模式 - `_stream_no_docs_response()` 方法**

```python
def _stream_no_docs_response(self, question):
    """
    当没有找到相关文档时的流式响应
    直接调用 LLM 进行对话(不依赖知识库)
    """
    import json
    
    print(f"[INFO] 没有找到相关文档,直接使用 LLM 对话")
    
    # 创建对话提示词
    from langchain_core.prompts import ChatPromptTemplate
    
    chat_prompt = ChatPromptTemplate.from_messages([
        ("system", """你是一个专业的保险行业知识助手。
        
虽然当前知识库中没有找到与用户问题直接相关的文档,但你可以基于你的通用知识来回答问题。

回答要求:
1. 提供准确、专业的回答
2. 如果问题超出你的知识范围,请诚实说明
3. 回答要简洁明了,重点突出
4. 如果涉及专业术语,请适当解释
5. 可以建议用户上传相关文档以获得更准确的答案

用户问题: {question}

请提供详细的回答:"""),
    ])
    
    # 格式化消息
    messages = chat_prompt.format_messages(question=question)
    
    # 流式生成回答
    full_answer = ""
    token_count = 0
    
    for chunk in self.llm.stream(messages):
        if chunk.content:
            token_count += 1
            full_answer += chunk.content
            # 发送文本块
            yield f"data: {json.dumps({'type': 'token', 'content': chunk.content}, ensure_ascii=False)}\n\n"
    
    # 发送完成信号
    yield f"data: {json.dumps({'type': 'done', 'answer': full_answer}, ensure_ascii=False)}\n\n"
```

**2. 非流式模式 - `query()` 方法**

```python
if not relevant_docs:
    # 如果是流式输出,返回流式生成器
    if stream:
        return self._stream_no_docs_response(question)
    # 非流式输出,直接调用 LLM 对话
    else:
        print(f"[INFO] 没有找到相关文档,直接使用 LLM 对话(非流式)")
        
        # 创建对话提示词
        chat_prompt = ChatPromptTemplate.from_messages([
            ("system", """你是一个专业的保险行业知识助手。
            
虽然当前知识库中没有找到与用户问题直接相关的文档,但你可以基于你的通用知识来回答问题。

回答要求:
1. 提供准确、专业的回答
2. 如果问题超出你的知识范围,请诚实说明
3. 回答要简洁明了,重点突出
4. 如果涉及专业术语,请适当解释
5. 可以建议用户上传相关文档以获得更准确的答案

用户问题: {question}

请提供详细的回答:"""),
        ])
        
        # 格式化消息
        messages = chat_prompt.format_messages(question=question)
        
        # 调用 LLM
        response = self.llm.invoke(messages)
        answer = response.content
        
        return {
            "success": True,
            "answer": answer,
            "sources": [],
            "question": question
        }
```

### 测试结果

```bash
$ python test_empty_kb_chat.py

============================================================
测试空知识库聊天功能
============================================================

1️⃣  登录系统...
✅ 登录成功

2️⃣  测试流式聊天(空知识库)...

============================================================
问题 1: 你好,请介绍一下自己
============================================================
✅ 开始接收流式数据...

✅ 完成!

完整答案:
------------------------------------------------------------
您好！我是您的专业保险行业知识助手，专注于提供与保险相关的各类信息和解答。我的核心功能包括：

1. **保险产品解析**：帮助您理解各类保险（如寿险、健康险、财产险等）的条款、覆盖范围和适用场景。
2. **理赔流程指导**：解答关于索赔条件、所需材料、常见问题及时效的疑问。
3. **行业术语解释**：用通俗语言说明专业术语（如"免赔额""现金价值"等），降低理解门槛。
4. **政策与法规更新**：提供最新监管动态或政策调整的简要说明（需基于您的文档或通用知识）。

**注意事项**：
- 我的回答基于您上传的文档内容（如合同、条款等）或通用保险知识。若问题涉及具体文件（如某公司保单），建议上传文档以获得更精准的答案。
- 对于超出保险领域或需个性化建议（如财务规划）的问题，我会如实告知局限性，并建议咨询专业顾问。

如果需要帮助，请随时提供更多细节或文档！ 😊
------------------------------------------------------------
💾 QA 记录 ID: 2

📊 统计:
   总事件数: 51
   Token 数: 49
   答案长度: 403 字符

✅ 测试通过! 空知识库也能正常聊天!
```

### 使用场景

#### 场景 1: 知识库为空
```
用户: 你好,请介绍一下自己
AI: 您好！我是您的专业保险行业知识助手...
```

#### 场景 2: 知识库有文档但不相关
```
用户: 什么是量子计算?
AI: (知识库中没有相关文档)
    量子计算是一种利用量子力学原理进行计算的技术...
    
    💡 提示: 如果您需要保险相关的专业信息,建议上传相关文档以获得更准确的答案。
```

#### 场景 3: 知识库有相关文档
```
用户: 投保人需要提供哪些材料?
AI: (知识库中找到相关文档)
    根据知识库文档,投保人需要提供以下材料:
    1. 身份证原件及复印件
    2. 投保申请书
    3. 健康告知书
    4. 银行卡信息
    
    📚 参考来源: [保险业务知识.pdf]
```

### 优势

1. **更好的用户体验**
   - 即使没有上传文档,也能获得有价值的回答
   - 不会因为知识库为空而无法使用

2. **智能降级**
   - 优先使用知识库文档(RAG 模式)
   - 没有文档时降级为通用对话(LLM 模式)

3. **引导用户**
   - 在回答中建议用户上传文档
   - 提示如何获得更准确的答案

4. **保持一致性**
   - 流式和非流式模式都支持
   - 用户体验保持一致

### 提示词设计

系统提示词包含以下要点:

1. **角色定位**: 专业的保险行业知识助手
2. **当前状态**: 说明知识库中没有找到相关文档
3. **回答要求**:
   - 提供准确、专业的回答
   - 诚实说明知识范围
   - 简洁明了,重点突出
   - 解释专业术语
   - 建议上传文档

### 测试用例

| 问题 | 预期行为 |
|------|----------|
| 你好,请介绍一下自己 | 介绍自己的功能和能力 |
| 什么是保险? | 解释保险的基本概念 |
| 投保人和被保险人有什么区别? | 解释两者的区别 |
| 如何选择合适的保险产品? | 提供选择建议 |

### 相关文件

- ✅ `backend/app/services/rag_service.py` - 核心实现
- ✅ `backend/test_empty_kb_chat.py` - 测试脚本
- ✅ `doc/空知识库聊天功能.md` - 功能文档

### 下一步

现在可以在浏览器中测试:

1. **刷新页面**: 按 F5 刷新浏览器
2. **访问知识问答**: 点击左侧菜单 "知识问答"
3. **直接提问**: 不需要上传文档,直接输入问题
4. **观察效果**: 
   - ✅ 文本逐字显示
   - ✅ 绿色光标闪烁
   - ✅ 智能回答
   - ✅ 无参考来源(因为知识库为空)

### 示例对话

```
用户: 你好
AI: 您好！我是您的专业保险行业知识助手...▊

用户: 什么是保险?
AI: 保险是一种风险管理工具...▊

用户: 投保人和被保险人有什么区别?
AI: 投保人和被保险人是保险合同中的两个重要角色...▊
```

所有功能已实现! 🎉 现在即使知识库为空,也能正常聊天了! 🎊

