# 多模型配置功能 - 部署检查清单

## 📋 部署前检查

### 1. 代码文件检查

#### 后端文件 ✅

- [ ] `backend/app/models/model_config.py` - 数据模型文件存在
- [ ] `backend/app/schemas/model_config.py` - Schema 文件存在
- [ ] `backend/app/api/v1/endpoints/model_config.py` - API 路由文件存在
- [ ] `backend/create_model_configs_table.py` - 迁移脚本存在
- [ ] `backend/app/db/base.py` - 已导入 ModelConfig
- [ ] `backend/app/api/v1/__init__.py` - 已注册 model_config 路由
- [ ] `backend/app/services/ai_service.py` - 已更新支持动态配置

#### 前端文件 ✅

- [ ] `frontend/src/pages/ModelConfigs.tsx` - 页面组件存在
- [ ] `frontend/src/services/api.ts` - 已添加 modelConfigAPI
- [ ] `frontend/src/App.tsx` - 已添加路由
- [ ] `frontend/src/components/Layout.tsx` - 已添加菜单项

#### 脚本文件 ✅

- [ ] `bat/create-model-configs-table.bat` - Windows 脚本存在

#### 文档文件 ✅

- [ ] `doc/多模型配置功能说明.md` - 功能说明文档
- [ ] `doc/多模型配置快速开始.md` - 快速开始指南
- [ ] `doc/多模型配置测试指南.md` - 测试指南
- [ ] `doc/多模型配置实现总结.md` - 实现总结
- [ ] `doc/多模型配置部署检查清单.md` - 本文档
- [ ] `多模型配置功能-README.md` - 总体 README

### 2. 代码质量检查

- [ ] 所有文件无语法错误
- [ ] 所有导入语句正确
- [ ] 类型注解完整
- [ ] 错误处理完善
- [ ] 日志记录适当

### 3. 依赖检查

#### 后端依赖

- [ ] SQLAlchemy - 数据库 ORM
- [ ] Pydantic - 数据验证
- [ ] FastAPI - Web 框架
- [ ] psycopg - PostgreSQL 驱动

#### 前端依赖

- [ ] React - UI 框架
- [ ] Ant Design - UI 组件库
- [ ] Axios - HTTP 客户端
- [ ] React Router - 路由

## 🚀 部署步骤

### 步骤 1: 备份数据库

```bash
# 备份当前数据库
pg_dump -U postgres -d test_case_db > backup_$(date +%Y%m%d_%H%M%S).sql
```

- [ ] 数据库已备份

### 步骤 2: 更新代码

```bash
# 拉取最新代码
git pull origin main

# 或者复制新文件到服务器
```

- [ ] 代码已更新到服务器

### 步骤 3: 安装依赖

```bash
# 后端依赖(如有新增)
cd backend
pip install -r requirements.txt

# 前端依赖(如有新增)
cd frontend
npm install
```

- [ ] 后端依赖已安装
- [ ] 前端依赖已安装

### 步骤 4: 运行数据库迁移

```bash
# Windows
bat\create-model-configs-table.bat

# Linux/Mac
cd backend
python create_model_configs_table.py
```

- [ ] 迁移脚本执行成功
- [ ] model_configs 表已创建
- [ ] 现有配置已迁移

**验证:**
```sql
-- 检查表是否存在
SELECT * FROM model_configs;

-- 检查索引
SELECT indexname FROM pg_indexes WHERE tablename = 'model_configs';
```

### 步骤 5: 构建前端

```bash
cd frontend
npm run build
```

- [ ] 前端构建成功
- [ ] 无构建错误或警告

### 步骤 6: 重启服务

```bash
# 重启后端服务
cd backend
# 根据你的部署方式重启,例如:
# systemctl restart test-case-backend
# 或
# pm2 restart test-case-backend

# 重启前端服务(如果使用 pm2 或类似工具)
# pm2 restart test-case-frontend
```

- [ ] 后端服务已重启
- [ ] 前端服务已重启(如适用)
- [ ] 服务启动无错误

### 步骤 7: 验证部署

#### 后端验证

```bash
# 检查后端健康状态
curl http://localhost:8000/health

# 检查模型配置 API
curl http://localhost:8000/api/v1/model-configs/ \
  -H "Authorization: Bearer YOUR_TOKEN"
```

- [ ] 后端服务响应正常
- [ ] API 端点可访问
- [ ] 无错误日志

#### 前端验证

- [ ] 前端页面可访问
- [ ] 登录功能正常
- [ ] 左侧菜单显示"模型配置"(超级管理员)
- [ ] 模型配置页面可访问

## 🧪 功能测试

### 基础功能测试

- [ ] **访问页面**: 超级管理员可以访问模型配置页面
- [ ] **查看列表**: 显示现有配置(包括迁移的默认配置)
- [ ] **API Key 脱敏**: 列表中 API Key 正确脱敏
- [ ] **默认标识**: 默认模型显示金色星标

### CRUD 操作测试

- [ ] **创建配置**: 可以添加新的模型配置
- [ ] **读取配置**: 可以查看配置详情
- [ ] **更新配置**: 可以编辑现有配置
- [ ] **删除配置**: 可以删除非默认配置
- [ ] **设置默认**: 可以切换默认模型

### 表单验证测试

- [ ] **必填字段**: 必填字段验证生效
- [ ] **格式验证**: 配置名称格式验证生效
- [ ] **唯一性验证**: 重复名称提示错误
- [ ] **API Key 显示**: 编辑时显示完整 Key

### 权限测试

- [ ] **管理员访问**: 超级管理员可以访问
- [ ] **普通用户**: 普通用户无法访问
- [ ] **菜单显示**: 只对管理员显示菜单

### 集成测试

- [ ] **生成测试点**: 使用默认模型生成测试点成功
- [ ] **生成测试用例**: 使用默认模型生成测试用例成功
- [ ] **知识库问答**: 使用默认模型回答问题成功
- [ ] **切换模型**: 切换默认模型后功能正常

## 🔍 问题排查

### 常见问题检查

#### 问题 1: 数据库迁移失败

**检查项:**
- [ ] PostgreSQL 服务是否运行
- [ ] 数据库连接配置是否正确
- [ ] 数据库用户是否有创建表权限
- [ ] 是否已存在 model_configs 表

**解决方法:**
```bash
# 检查数据库连接
psql -U postgres -d test_case_db -c "SELECT 1"

# 检查表是否存在
psql -U postgres -d test_case_db -c "\dt model_configs"

# 如果表已存在但迁移失败,可以手动删除后重试
# psql -U postgres -d test_case_db -c "DROP TABLE model_configs"
```

#### 问题 2: 后端启动失败

**检查项:**
- [ ] 查看后端错误日志
- [ ] 检查是否有导入错误
- [ ] 检查数据库连接
- [ ] 检查端口是否被占用

**解决方法:**
```bash
# 查看详细错误
cd backend
python main.py

# 检查导入
python -c "from app.models.model_config import ModelConfig; print('OK')"
```

#### 问题 3: 前端页面空白或报错

**检查项:**
- [ ] 查看浏览器控制台错误
- [ ] 检查 API 请求是否成功
- [ ] 检查路由配置
- [ ] 检查组件导入

**解决方法:**
```bash
# 重新构建前端
cd frontend
rm -rf node_modules dist
npm install
npm run build
```

#### 问题 4: 菜单不显示

**检查项:**
- [ ] 是否使用超级管理员登录
- [ ] Layout.tsx 是否正确更新
- [ ] 前端是否重新构建

#### 问题 5: API 调用失败

**检查项:**
- [ ] 后端路由是否正确注册
- [ ] API 端点是否正确
- [ ] 认证 Token 是否有效
- [ ] CORS 配置是否正确

**测试 API:**
```bash
# 测试获取配置列表
curl -X GET http://localhost:8000/api/v1/model-configs/ \
  -H "Authorization: Bearer YOUR_TOKEN"

# 测试获取默认配置
curl -X GET http://localhost:8000/api/v1/model-configs/default/current \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 📊 性能检查

- [ ] 配置列表加载时间 < 1 秒
- [ ] 创建配置响应时间 < 500ms
- [ ] 更新配置响应时间 < 500ms
- [ ] 删除配置响应时间 < 500ms
- [ ] 设置默认模型响应时间 < 500ms

## 🔒 安全检查

- [ ] API Key 在列表中正确脱敏
- [ ] 只有超级管理员可以访问
- [ ] API 端点有权限验证
- [ ] 无 SQL 注入风险
- [ ] 无 XSS 风险
- [ ] HTTPS 配置(生产环境)

## 📝 文档检查

- [ ] 功能说明文档完整
- [ ] 快速开始指南清晰
- [ ] 测试指南详细
- [ ] API 文档准确
- [ ] 故障排除指南有用

## ✅ 最终确认

### 部署完成确认

- [ ] 所有代码文件已部署
- [ ] 数据库迁移成功
- [ ] 服务启动正常
- [ ] 基础功能测试通过
- [ ] 集成测试通过
- [ ] 性能符合要求
- [ ] 安全检查通过
- [ ] 文档齐全

### 回滚计划

如果部署出现问题,回滚步骤:

1. **恢复数据库**
```bash
# 删除 model_configs 表
psql -U postgres -d test_case_db -c "DROP TABLE model_configs"

# 或恢复备份
psql -U postgres -d test_case_db < backup_YYYYMMDD_HHMMSS.sql
```

2. **恢复代码**
```bash
git checkout <previous_commit>
```

3. **重启服务**
```bash
# 重启后端和前端服务
```

- [ ] 回滚计划已准备
- [ ] 备份可用

## 📞 支持联系

如果遇到问题:
1. 查看错误日志
2. 参考故障排除指南
3. 联系技术支持

---

**检查日期**: ___________  
**检查人员**: ___________  
**部署状态**: [ ] 成功 [ ] 失败 [ ] 部分成功  
**备注**: ___________

